#!/bin/bash

# ==============================================================================
# SCRIPT:  grafanaDemoInstall
# PURPOSE: Install Grafana, Prometheus, and node_exporter on Raspberry Pi
#          Preload Prometheus datasource and example dashboard (Node Exporter Full)
# USAGE: Run ON THE PI after restoring ~/scr
# ==============================================================================

set -e

# ------------------------------------------------------------------------------
# System update and base packages
# ------------------------------------------------------------------------------
echo "Updating system and installing base packages..."
sudo apt update && sudo apt install -y wget curl software-properties-common apt-transport-https

# ------------------------------------------------------------------------------
# Install Prometheus and node_exporter
# ------------------------------------------------------------------------------
echo "Installing Prometheus and node_exporter..."

sudo useradd --no-create-home --shell /usr/sbin/nologin prometheus || true
sudo mkdir -p /etc/prometheus /var/lib/prometheus

PROM_VER="2.52.0"
NODE_EXPORTER_VER="1.8.1"

wget https://github.com/prometheus/prometheus/releases/download/v$PROM_VER/prometheus-$PROM_VER.linux-armv7.tar.gz
tar xvf prometheus-$PROM_VER.linux-armv7.tar.gz
cd prometheus-$PROM_VER.linux-armv7
sudo cp prometheus promtool /usr/local/bin/
sudo cp -r consoles console_libraries /etc/prometheus/
sudo cp prometheus.yml /etc/prometheus/
cd ..
rm -rf prometheus-$PROM_VER.linux-armv7*

wget https://github.com/prometheus/node_exporter/releases/download/v$NODE_EXPORTER_VER/node_exporter-$NODE_EXPORTER_VER.linux-armv7.tar.gz
tar xvf node_exporter-$NODE_EXPORTER_VER.linux-armv7.tar.gz
cd node_exporter-$NODE_EXPORTER_VER.linux-armv7
sudo cp node_exporter /usr/local/bin/
cd ..
rm -rf node_exporter-$NODE_EXPORTER_VER.linux-armv7*

# ------------------------------------------------------------------------------
# Prometheus systemd service
# ------------------------------------------------------------------------------
echo "Configuring Prometheus service..."

cat <<EOF | sudo tee /etc/systemd/system/prometheus.service
[Unit]
Description=Prometheus Monitoring
Wants=network-online.target
After=network-online.target

[Service]
User=prometheus
ExecStart=/usr/local/bin/prometheus \
  --config.file=/etc/prometheus/prometheus.yml \
  --storage.tsdb.path=/var/lib/prometheus/ \
  --web.console.templates=/etc/prometheus/consoles \
  --web.console.libraries=/etc/prometheus/console_libraries

[Install]
WantedBy=multi-user.target
EOF

# ------------------------------------------------------------------------------
# node_exporter systemd service
# ------------------------------------------------------------------------------
echo "Configuring node_exporter service..."

cat <<EOF | sudo tee /etc/systemd/system/node_exporter.service
[Unit]
Description=Prometheus Node Exporter
After=network.target

[Service]
User=prometheus
ExecStart=/usr/local/bin/node_exporter

[Install]
WantedBy=default.target
EOF

# ------------------------------------------------------------------------------
# Start Prometheus + node_exporter
# ------------------------------------------------------------------------------
sudo systemctl daemon-reexec
sudo systemctl enable prometheus node_exporter
sudo systemctl start prometheus node_exporter

# ------------------------------------------------------------------------------
# Install Grafana
# ------------------------------------------------------------------------------
echo "Installing Grafana..."

sudo mkdir -p /etc/apt/keyrings
wget -q -O - https://apt.grafana.com/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/grafana.gpg
echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" \
  | sudo tee /etc/apt/sources.list.d/grafana.list

sudo apt update
sudo apt install -y grafana

# ------------------------------------------------------------------------------
# Provision Prometheus datasource
# ------------------------------------------------------------------------------
echo "Provisioning Prometheus datasource..."

sudo mkdir -p /etc/grafana/provisioning/datasources
cat <<EOF | sudo tee /etc/grafana/provisioning/datasources/prometheus.yaml
apiVersion: 1
datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://localhost:9090
    isDefault: true
EOF

# ------------------------------------------------------------------------------
# Enable and start Grafana
# ------------------------------------------------------------------------------
sudo systemctl enable grafana-server
sudo systemctl start grafana-server

# ------------------------------------------------------------------------------
# Wait and preload dashboard
# ------------------------------------------------------------------------------
echo "Waiting for Grafana to start..."
sleep 15

echo "Installing example dashboard (Node Exporter Full)..."

DASHBOARD_DIR=~/scr/grafana_dashboards
mkdir -p "$DASHBOARD_DIR"
wget -qO "$DASHBOARD_DIR/node_exporter_full.json" \
  https://grafana.com/api/dashboards/1860/revisions/32/download

curl -s -X POST http://localhost:3000/api/dashboards/db \
  -H "Content-Type: application/json" \
  -u admin:admin \
  -d @- <<EOF
{
  "dashboard": $(cat "$DASHBOARD_DIR/node_exporter_full.json"),
  "overwrite": true,
  "folderId": 0
}
EOF

echo "Grafana Stack installed. Access Grafana at: http://<your-pi-ip>:3000"
echo "Login: admin / admin"
