#!/bin/bash
# installGrafana.sh - Installs Grafana and provisions a sample dashboard + InfluxDB data source

set -e

echo "ðŸ“¦ Installing Grafana..."

# Add Grafana APT repo
sudo mkdir -p /etc/apt/keyrings
wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | sudo tee /etc/apt/keyrings/grafana.gpg > /dev/null
echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" | sudo tee /etc/apt/sources.list.d/grafana.list

sudo apt update
sudo apt install -y grafana

# Enable and start Grafana
sudo systemctl enable grafana-server
sudo systemctl start grafana-server

# -------- Provision InfluxDB Data Source --------
echo "âš™ï¸  Setting up InfluxDB as a data source..."

sudo mkdir -p /etc/grafana/provisioning/datasources

sudo tee /etc/grafana/provisioning/datasources/influxdb.yaml > /dev/null <<EOF
apiVersion: 1
datasources:
  - name: InfluxDB
    type: influxdb
    access: proxy
    url: http://localhost:8086
    database: telegraf
    isDefault: true
EOF

# -------- Provision Sample Dashboard --------
echo "ðŸ“Š Provisioning sample Telegraf dashboard..."

sudo mkdir -p /etc/grafana/provisioning/dashboards
sudo mkdir -p /var/lib/grafana/dashboards

# Dashboard provisioning config
sudo tee /etc/grafana/provisioning/dashboards/sample.yaml > /dev/null <<EOF
apiVersion: 1
providers:
  - name: 'Telegraf System Metrics'
    folder: ''
    type: file
    options:
      path: /var/lib/grafana/dashboards
EOF

# Sample dashboard JSON (minimal)
sudo tee /var/lib/grafana/dashboards/telegraf-system.json > /dev/null <<EOF
{
  "title": "Telegraf System Metrics",
  "timezone": "browser",
  "panels": [
    {
      "type": "graph",
      "title": "CPU Usage",
      "targets": [
        {
          "measurement": "cpu",
          "groupBy": [{"type": "time", "params": ["\$__interval"]}],
          "select": [[{"type": "field", "params": ["usage_user"]}, {"type": "mean"}]],
          "tags": [{"key": "cpu", "operator": "=", "value": "cpu-total"}],
          "refId": "A"
        }
      ],
      "datasource": "InfluxDB"
    },
    {
      "type": "graph",
      "title": "Memory Usage",
      "targets": [
        {
          "measurement": "mem",
          "select": [[{"type": "field", "params": ["used_percent"]}, {"type": "mean"}]],
          "refId": "B"
        }
      ],
      "datasource": "InfluxDB"
    }
  ],
  "schemaVersion": 26,
  "version": 1
}
EOF

# Restart to load provisioned sources + dashboard
sudo systemctl restart grafana-server

echo "âœ… Grafana installed and preloaded with InfluxDB data source and dashboard."
echo "âž¡ Access it at: http://<your_pi_ip>:3000 (login: admin / admin)"
