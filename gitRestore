#!/bin/bash

# ==============================================================================
# SCRIPT: gitRestore
# PURPOSE: Restore scripts and config from a backup tarball
#          - Defaults to most recent backup in /mnt/ssd/backups
#          - Optionally rehydrates ~/.ssh, .gitconfig, or other dotfiles
# ==============================================================================

set -e

BACKUP_DIR="/mnt/ssd/backups"
DEFAULT_REPO_DIR="/mnt/ssd/RPi5"
DEFAULT_CONF_DIR="/mnt/ssd/grafana-config"

# Get most recent backup file if not provided
BACKUP_FILE="$1"
if [[ -z "$BACKUP_FILE" ]]; then
  BACKUP_FILE=$(ls -t "$BACKUP_DIR"/backup-*.tar.gz | head -n 1)
  echo "üóÇÔ∏è  No file provided. Using most recent backup: $BACKUP_FILE"
fi

if [[ ! -f "$BACKUP_FILE" ]]; then
  echo "‚ùå Backup file not found: $BACKUP_FILE"
  exit 1
fi

read -rp "üìÇ Restore to existing /mnt/ssd layout? This will overwrite scripts and config. [y/N]: " confirm_restore
if [[ "$confirm_restore" =~ ^[Yy]$ ]]; then
  tar -xzf "$BACKUP_FILE" -C /
  echo "‚úÖ Restore complete."
else
  echo "‚è≠Ô∏è  Restore cancelled."
  exit 0
fi

# Optional: Restore dotfiles
echo
read -rp "üîë Rehydrate ~/.ssh and .gitconfig from SSD (if stored separately)? [y/N]: " confirm_dotfiles
if [[ "$confirm_dotfiles" =~ ^[Yy]$ ]]; then
  if [[ -d "/mnt/ssd/dotfiles/.ssh" ]]; then
    cp -r /mnt/ssd/dotfiles/.ssh ~/.ssh
    chmod 700 ~/.ssh
    chmod 600 ~/.ssh/*
    echo "‚úÖ Restored ~/.ssh"
  fi
  if [[ -f "/mnt/ssd/dotfiles/.gitconfig" ]]; then
    cp /mnt/ssd/dotfiles/.gitconfig ~/
    echo "‚úÖ Restored .gitconfig"
  fi
else
  echo "‚è≠Ô∏è  Skipping dotfiles restore."
fi